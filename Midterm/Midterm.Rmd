---
title: "Midterm"
author: "Sylvia Baeyens"
date: "due 10/22/2021"
output:
  github_document:
    html_preview: false
  html_document: default
  word_document: default
always_allow_html: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(repos = c(CRAN = "http://cran.rstudio.com"))
```


```{r packages, echo= FALSE, include= FALSE}
#including necessary libraries
library(tidyverse)
library(tidytext)
library(dplyr)
library(ggplot2)
library(R.utils)
library(data.table)
```

## Introduction

(provide background on your dataset and formulated question)

## Methods

In order to answer the main question, multiple datasets were acquired from various sources. The data can be organized into 3 categories: anemia data, meat consumption data, and country data.

# Anemia Data

The data sets related to the prevalence of anemia in 15-49 year old women in low and middle income countries (LMIC) were exported from ghdx.healthdata.org. This data was collected by the Institute of Health Metrics and Evaluation with the funding from the Bill and Melinda Gates Foundation between January 2000 and December 2019. It was published in 2021. There were three different csv files in this set, one for mild anemia, one for moderate anemia, and one for severe anemia. The data sets detailed the prevalence of each kind of anemia every year in 82 LMICs at a 5x5km level. These csv's were downloaded from the site manually and read into data tables in the R code. From there, variable names were changed to improve ease of merging. Instead of keeping the data at the 5x5km level, the mean anemia prevalence was found by country and year. Finally, the three data tables (moderate, mild, and severe) were merged into the data table "TotalAnemia". This table included all 82 countries and the mild, moderate, and severe percentages of anemia prevalence for every year from 2000 to 2019. No values were found to be missing or unreasonable. 


```{r anemia data cleanup, echo= FALSE, include= FALSE}
#reading in all 3 anemia data sets: mild, moderate & severe
#changing mean variable to be representative of the type of anemia

#full url of data is http://ghdx.healthdata.org/record/ihme-data/global-anemia-prevalence-geospatial-estimates-2000-2019

mildAnemia= data.table::fread("MildAnemia.CSV") 
mildAnemia = mildAnemia %>%
  rename(COUNTRY = "ADM0_NAME", mildPct = "mean")

modAnemia= data.table::fread("ModerateAnemia.CSV") 
modAnemia = modAnemia %>%
  rename(COUNTRY = "ADM0_NAME", modPct = "mean")

sevAnemia= data.table::fread("SevereAnemia.CSV") 
sevAnemia = sevAnemia %>%
  rename(COUNTRY = "ADM0_NAME", sevPct = "mean")

# finding mean Anemia pct by country & year
mildAvg = mildAnemia[,.(
  mildPct = mean(mildPct,na.rm = TRUE)
  ), by = c("COUNTRY", "year")]
modAvg = modAnemia[,.(
  modPct = mean(modPct,na.rm = TRUE)
  ), by = c("COUNTRY", "year")]
sevAvg = sevAnemia[,.(
  sevPct = mean(sevPct,na.rm = TRUE)
  ), by = c("COUNTRY", "year")]

# merging all 3 anemia data frames
TotalAnemia = merge(
  x = mildAvg,
  y = modAvg,
  all.x = TRUE, all.y = FALSE
)

TotalAnemia = merge(
  x = TotalAnemia,
  y = sevAvg,
  all.x = TRUE, all.y = FALSE
)

#check for any missing data
TotalAnemia[,table(is.na(mildPct))]
TotalAnemia[,table(is.na(modPct))]
TotalAnemia[,table(is.na(sevPct))]
#no missing data
```

# Meat Consumption Data 

The data set related to meat food supply quantity in terms of kilograms per capita per year was exported from ourworldindata.org. This data was sourced from data published by the United Nations Food and Agricultural Organization (FAO) in 2020. The data was collected from 1961 to 2017. This csv file was also exported manually from the website and read into a data table within the R code. It contains data from 215 countries and was not found to have any missing values. The data only had 4 variables: the country name, 3 letter country code, year, and meat food supply quantity; these variables were renamed for ease of use and to match the names of the anemia data table.

```{r meat data cleanup, echo= FALSE, include= FALSE}
#reading in meat dataset
# url : https://ourworldindata.org/meat-production#which-countries-eat-the-most-meat

meatData= data.table::fread("meat-supply-per-person.csv") 
colnames(meatData) = c("COUNTRY", "code", "year", "consumption")

unique(meatData$COUNTRY)

#check for missing data
meatData[,table(is.na(consumption))]
# no missing data
```

# country data & final data table

Following preliminary data cleanup and wrangling, the TotalAnemia and meatData data tables were merged together by country and year to create a new data table: TotalData. All observations from the TotalAnemia data table were kept. To add a final level of analysis, a country code data set was downloaded and read in by the R code. This csv file was found on datahub.io, and lists every country, along with its three letter country code, continent, and other identifying information; only the three letter code and continent were selcted for. This country code data set was then merged with the TotalData set by code, so that every observation now included the continent as well.

Final data cleanup and wrangling was now performed. Any observations missing meat consumption values were removed. The data table was now left with data for 69 LMICs, for a total of 1258 observations. When looking at summaries and visualizations of the various variables, no data looked unreasonable. The results of these summary statistics are printed below: 


```{r merging all data, echo= FALSE, include= FALSE}
#selecting necessary info from meat data & only considering beef

#merging meat & anemia data
TotalData = merge(
  x = TotalAnemia,
  y = meatData,
  all.x = TRUE, all.y = FALSE
)

#download country code csv
countryCodes= "countryCodes.csv"
if(!file.exists(countryCodes)){
   download.file("https://pkgstore.datahub.io/JohnSnowLabs/country-and-continent-codes-list/country-and-continent-codes-list-csv_csv/data/b7876b7f496677669644f3d1069d3121/country-and-continent-codes-list-csv_csv.csv", destfile = countryCodes)}

countryCodes= data.table::fread(countryCodes)
countryCodes = countryCodes %>%
  rename(CONTINENT = "Continent_Name", code= "Three_Letter_Country_Code") %>%
  select(code, CONTINENT)

#merging country code data frame & Total Data data frame so that the total data frame includes continent name
TotalData = merge(
  x = TotalData,
  y = countryCodes,
  all.x = TRUE, all.y = FALSE,
  by = "code"
)


TotalData[,table(is.na(consumption))]
#missing 392/1640 -> some whole countries are missing, some years for specific countries missing

TotalData = na.omit(TotalData)
#removed all rows with NAs -> 1258 obs 

unique(TotalData$COUNTRY)

summary(TotalData)
#no data looks out of the ordinary

hist(TotalData$consumption)
hist(TotalData$mildPct)
hist(TotalData$modPct)
hist(TotalData$sevPct)

```

```{r summary table, echo= FALSE, include= FALSE}
TotalData[, .(
    consumption = quantile(consumption, na.rm=TRUE),
    mild_anemia_percentage = quantile(mildPct, na.rm=TRUE),
    moderate_anemia_percentage = quantile(modPct, na.rm=TRUE),
    severe_anemia_percentage = quantile(sevPct, na.rm=TRUE)
    )
    ] %>% knitr::kable(caption = "Quantiles (minimum, 25%, median, 75%, maximum) for Selected Variables in TotalData data frame")
#, row.names = c("Minimum", "First Quantile", "Median", "Third Quantile", "Maximum"))

```

## Preliminary Results

(provide summary statistics in tabular form and publication-quality figures, take a look at the kable function from knitr to write nice tables in Rmarkdown)

```{r, echo= FALSE, include= FALSE}

ggplot(TotalData,aes(x=consumption, y=(mildPct+modPct+sevPct)*100)) +
  geom_point() +
  geom_smooth(method= "lm") +
  ggtitle("Visualizing the Relationship between Anemia & Meat Consumption in Underdeveloped Countries")+
  ylab('Total Percentage of Women 15-49 with Anemia of any Severity')+
  xlab('Meat Consumption (kg/capital/year')

TotalData %>%
  filter("Asia"== CONTINENT) %>%
  ggplot(aes(x=year, y=(mildPct+modPct+sevPct)*100)) +
    facet_wrap(~COUNTRY, nrow= 8) +
    geom_point() +
    geom_smooth(method= "lm")+
    ggtitle("Anemia in Young Women in underdeveloped Asian Countries")+
    theme(axis.text.x = element_text(angle = 45))+
    ylab('Total Percentage of Women 15-49 with Anemia of any Severity')

TotalData %>%
  filter("Africa"== CONTINENT) %>%
  ggplot(aes(x=year, y=(mildPct+modPct+sevPct)*100)) +
    facet_wrap(~COUNTRY, nrow= 8) +
    geom_point() +
    geom_smooth(method= "lm")+
    ggtitle("Anemia in Young Women in underdeveloped African Countries")+
    theme(axis.text.x = element_text(angle = 45))+
    ylab('Total Percentage of Women 15-49 with Anemia of any Severity')

TotalData %>%
  filter("South America"== CONTINENT) %>%
  ggplot(aes(x=year, y=(mildPct+modPct+sevPct)*100)) +
    facet_wrap(~COUNTRY, nrow= 3) +
    geom_point() +
    geom_smooth(method= "lm")+
    ggtitle("Anemia in Young Women in underdeveloped South American Countries")+
    theme(axis.text.x = element_text(angle = 45))+
    ylab('Total Percentage of Women 15-49 with Anemia of any Severity')

TotalData %>%
  filter("North America"== CONTINENT) %>%
  ggplot(aes(x=year, y=(mildPct+modPct+sevPct)*100)) +
    facet_wrap(~COUNTRY, nrow= 3) +
    geom_point() +
    geom_smooth(method= "lm")+
    ggtitle("Anemia in Young Women in underdeveloped North American Countries")+
    theme(axis.text.x = element_text(angle = 45))+
    ylab('Total Percentage of Women 15-49 with Anemia of any Severity')
```

```{r, echo= FALSE, include= FALSE}

#looking at averages for each country

TotalDataAvg = TotalData[,.(
  consumption = mean(consumption,na.rm = TRUE),
  mildPct = mean(mildPct,na.rm = TRUE),
  modPct = mean(modPct,na.rm = TRUE),
  sevPct = mean(sevPct,na.rm = TRUE)
),by = "COUNTRY"]


ggplot(data = TotalDataAvg, mapping = aes(x = reorder(COUNTRY, consumption), consumption)) + 
  geom_bar(stat = "identity") + coord_flip()

ggplot(data = TotalDataAvg, mapping = aes(reorder(COUNTRY, mildPct+modPct+sevPct), (mildPct+modPct+sevPct)*100)) + 
  geom_bar(stat = "identity") + coord_flip()
```


## Conclusion
